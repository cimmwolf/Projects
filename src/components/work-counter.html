<link rel="import" href="../../bower_components/polymer/polymer.html">

<script src="../../bower_components/moment/min/moment.min.js"></script>

<dom-module id="work-counter">
    <template>
        <style>
            :host { display: block; }
        </style>

        <p>
            Reports analyze:
        </p>
        <template is="dom-repeat" items="[[visibleMonths]]">
            <p>[[item.month]]</p>
            <ul>
                <template is="dom-repeat" items="[[item.data]]" as="person" sort="_sortNames">
                    <li>[[person.name]]: [[_toHumanTimeString(person.value)]]</li>
                </template>
            </ul>
        </template>
        <div class="text-center">
            <button class$="btn btn-pseudo [[_showMoreClass(step, months.*)]]" on-tap="_showMore">Show more</button>
        </div>
        <content></content>
    </template>
    <script>
        Polymer({
            is: 'work-counter',
            properties: {
                data: {type: Array, value: []},
                months: {type: Array, value: []},
                visibleMonths: {
                    type: Array,
                    computed: '_filterMonthsByIndex(months.*, step)'
                },
                step: {
                    type: Number,
                    value: 3
                }
            },
            observers: [
                '_countByMonth(data.*)'
            ],
            _countByMonth: function (changeRecord) {
                var i, j, k, mLength, month, noHave,
                    data = changeRecord.value,
                    length = data.length;

                for (i = 0; i < length; i++) {
                    noHave = true;
                    j = this._generateMonths(data[i].date);
                    mLength = this.months[j].data.length;
                    for (k = 0; k < mLength; k++) {
                        month = this.months[j].data[k];
                        if (month.name == data[i].name) {
                            noHave = false;
                            month.value += data[i].value;
                        }
                    }
                    if (noHave)
                        this.months[j].data.push({name: data[i].name, value: data[i].value});
                }
            },
            _generateMonths: function (date) {
                var i = 0, month = moment().utc().startOf('month');

                do {
                    if (this.months[i++] == null)
                        this.push('months', {month: month.format('MMM, YY'), data: []});
                    month.subtract(1, 'months');
                } while (!month.isBefore(date, 'month'));
                return i - 1;
            },
            _filterMonthsByIndex: function () {
                return this.months.slice(0, this.step);
            },
            _sortNames: function (a, b) {
                if (a.name > b.name) {
                    return 1;
                }
                if (a.name < b.name) {
                    return -1;
                }
                return 0;
            },
            _toHumanTimeString: function (minutes) {
                var hString, hours;
                hours = Math.floor(minutes / 60);
                if (hours !== 0) {
                    if (minutes / 60 > hours) {
                        minutes = Math.round(60 * (minutes / 60 - hours));
                        hString = hours + ' h. ' + minutes + ' min.';
                    } else {
                        hString = hours + ' h.';
                    }
                } else {
                    hString = Math.round(60 * (minutes / 60 - hours)) + ' min.';
                }
                return hString;
            },
            _showMore: function () {
                this.step += this.step;
            },
            _showMoreClass: function () {
                if (this.step < this.months.length)
                    return '';
                else
                    return 'hidden';
            }
        })
    </script>
</dom-module>